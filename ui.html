<!doctype html>
<html>
  <head>
    <style>
      body {
        font-family: Inter, sans-serif;
        margin: 0;
        padding: 16px;
      }
      input,
      select,
      button {
        width: 100%;
        margin-bottom: 12px;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #e5e5e5;
      }
      button {
        background-color: #18a0fb;
        color: white;
        border: none;
        cursor: pointer;
        padding: 10px;
      }
      button:disabled {
        background-color: #cccccc;
      }
      .output {
        margin-top: 16px;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
        padding: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
      .error {
        color: #d93025;
      }
      .success {
        color: #137333;
      }
    </style>
  </head>
  <body>
    <h2>SVG 아이콘 Git 자동화</h2>

    <div>
      <label for="repoUrl">Git Repository URL:</label>
      <input
        id="repoUrl"
        type="text"
        placeholder="https://github.com/username/repo.git"
      />
    </div>

    <div>
      <label for="token">GitHub 접근 토큰:</label>
      <input
        id="token"
        type="password"
        placeholder="GitHub Personal Access Token"
      />
    </div>

    <div>
      <label for="iconPath">아이콘 라이브러리 경로:</label>
      <input id="iconPath" type="text" placeholder="src/assets/icons" />
    </div>

    <div>
      <label for="branchName">Feature 브랜치 이름:</label>
      <input id="branchName" type="text" placeholder="feature/new-icons" />
    </div>

    <div>
      <label for="commitMessage">커밋 메시지:</label>
      <input id="commitMessage" type="text" placeholder="Add new icons" />
    </div>

    <button id="exportButton">아이콘 내보내기 및 PR 생성</button>

    <div class="output" id="output">로그 메시지가 여기에 표시됩니다.</div>

    <script>
      let svgExports = [];
      const output = document.getElementById('output');
      const exportButton = document.getElementById('exportButton');

      // 피그마로부터 메시지 수신
      window.onmessage = async (event) => {
        const msg = event.data.pluginMessage;

        if (msg.type === 'svg-exports') {
          svgExports = msg.data;
          log(`${svgExports.length}개의 아이콘이 내보내졌습니다.`, 'success');

          if (svgExports.length > 0) {
            await createGitPR();
          }
        } else if (msg.type === 'error') {
          log(msg.message, 'error');
        }
      };

      // 로그 메시지 표시
      function log(message, type = '') {
        const p = document.createElement('p');
        p.textContent = message;
        p.className = type;
        output.appendChild(p);
        output.scrollTop = output.scrollHeight;
      }

      // GitHub API를 사용하여 PR 생성
      async function createGitPR() {
        try {
          const repoUrl = document.getElementById('repoUrl').value;
          const token = document.getElementById('token').value;
          const iconPath = document.getElementById('iconPath').value;
          const branchName = document.getElementById('branchName').value;
          const commitMessage = document.getElementById('commitMessage').value;

          if (
            !repoUrl ||
            !token ||
            !iconPath ||
            !branchName ||
            !commitMessage
          ) {
            log('모든 필드를 채워주세요.', 'error');
            return;
          }

          log('GitHub 연결 시도 중...');
          exportButton.disabled = true;

          // 레포지토리 정보 파싱
          const repoInfo = parseRepoUrl(repoUrl);
          if (!repoInfo) {
            log('유효하지 않은 GitHub 레포지토리 URL입니다.', 'error');
            exportButton.disabled = false;
            return;
          }

          // 1. main 브랜치에서 최신 커밋 SHA 가져오기
          log('main 브랜치 정보 가져오는 중...');
          const mainRef = await fetchRef(repoInfo, token, 'main');
          if (!mainRef) {
            exportButton.disabled = false;
            return;
          }

          // 2. 새 브랜치 생성
          log(`"${branchName}" 브랜치 생성 중...`);
          const branchCreated = await createBranch(
            repoInfo,
            token,
            branchName,
            mainRef.object.sha
          );
          if (!branchCreated) {
            exportButton.disabled = false;
            return;
          }

          // 3. 각 SVG 파일을 레포지토리에 업로드
          log('SVG 파일을 업로드하는 중...');
          const fileUploads = [];

          for (const svgExport of svgExports) {
            const filePath = `${iconPath}/${svgExport.name}.svg`;
            log(`파일 업로드 중: ${filePath}`);

            const fileUploaded = await uploadFile(
              repoInfo,
              token,
              filePath,
              svgExport.svg,
              commitMessage,
              branchName
            );

            fileUploads.push(fileUploaded);
          }

          if (fileUploads.some((upload) => !upload)) {
            log('일부 파일 업로드에 실패했습니다.', 'error');
            exportButton.disabled = false;
            return;
          }

          // 4. PR 생성
          log('Pull Request 생성 중...');
          const prCreated = await createPullRequest(
            repoInfo,
            token,
            branchName,
            'main',
            `${commitMessage} (${svgExports.length} icons)`,
            `이 PR은 ${svgExports.length}개의 새 아이콘을 추가합니다.`
          );

          if (prCreated) {
            log(
              `PR이 성공적으로 생성되었습니다: ${prCreated.html_url}`,
              'success'
            );
          }

          exportButton.disabled = false;
        } catch (error) {
          log(`오류 발생: ${error.message}`, 'error');
          exportButton.disabled = false;
        }
      }

      // GitHub URL 파싱
      function parseRepoUrl(url) {
        try {
          const regex = /github\.com\/([^\/]+)\/([^\/\.]+)/;
          const match = url.match(regex);

          if (match && match.length >= 3) {
            return {
              owner: match[1],
              repo: match[2],
            };
          }

          return null;
        } catch (error) {
          log(`URL 파싱 오류: ${error.message}`, 'error');
          return null;
        }
      }

      // GitHub API 호출 함수
      async function fetchRef(repoInfo, token, branch) {
        try {
          const response = await fetch(
            `https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}/git/refs/heads/${branch}`,
            {
              headers: {
                Authorization: `token ${token}`,
                'Content-Type': 'application/json',
                Accept: 'application/vnd.github.v3+json',
              },
            }
          );

          if (!response.ok) {
            log(`브랜치 정보 가져오기 실패: ${response.statusText}`, 'error');
            return null;
          }

          return await response.json();
        } catch (error) {
          log(`API 호출 오류: ${error.message}`, 'error');
          return null;
        }
      }

      async function createBranch(repoInfo, token, branchName, sha) {
        try {
          const response = await fetch(
            `https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}/git/refs`,
            {
              method: 'POST',
              headers: {
                Authorization: `token ${token}`,
                'Content-Type': 'application/json',
                Accept: 'application/vnd.github.v3+json',
              },
              body: JSON.stringify({
                ref: `refs/heads/${branchName}`,
                sha: sha,
              }),
            }
          );

          if (!response.ok) {
            const error = await response.json();
            if (
              error.message &&
              error.message.includes('Reference already exists')
            ) {
              log(
                `브랜치 "${branchName}"가 이미 존재합니다. 해당 브랜치를 사용합니다.`,
                'success'
              );
              return true;
            }

            log(`브랜치 생성 실패: ${response.statusText}`, 'error');
            return false;
          }

          return true;
        } catch (error) {
          log(`API 호출 오류: ${error.message}`, 'error');
          return false;
        }
      }

      async function uploadFile(
        repoInfo,
        token,
        path,
        content,
        message,
        branch
      ) {
        try {
          // Base64로 인코딩
          const contentEncoded = btoa(unescape(encodeURIComponent(content)));

          const response = await fetch(
            `https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}/contents/${path}`,
            {
              method: 'PUT',
              headers: {
                Authorization: `token ${token}`,
                'Content-Type': 'application/json',
                Accept: 'application/vnd.github.v3+json',
              },
              body: JSON.stringify({
                message,
                content: contentEncoded,
                branch,
              }),
            }
          );

          if (!response.ok) {
            log(`파일 업로드 실패: ${path} - ${response.statusText}`, 'error');
            return false;
          }

          return true;
        } catch (error) {
          log(`API 호출 오류: ${error.message}`, 'error');
          return false;
        }
      }

      async function createPullRequest(
        repoInfo,
        token,
        head,
        base,
        title,
        body
      ) {
        try {
          const response = await fetch(
            `https://api.github.com/repos/${repoInfo.owner}/${repoInfo.repo}/pulls`,
            {
              method: 'POST',
              headers: {
                Authorization: `token ${token}`,
                'Content-Type': 'application/json',
                Accept: 'application/vnd.github.v3+json',
              },
              body: JSON.stringify({
                title,
                body,
                head,
                base,
              }),
            }
          );

          if (!response.ok) {
            log(`PR 생성 실패: ${response.statusText}`, 'error');
            return null;
          }

          return await response.json();
        } catch (error) {
          log(`API 호출 오류: ${error.message}`, 'error');
          return null;
        }
      }

      // 이벤트 리스너 등록
      document.getElementById('exportButton').onclick = () => {
        output.innerHTML = '';
        log('아이콘 내보내기 시작...');
        parent.postMessage({ pluginMessage: { type: 'export-svg' } }, '*');
      };
    </script>
  </body>
</html>
