<!doctype html>
<html>
  <head>
    <style>
      body {
        font-family: Inter, sans-serif;
        margin: 0;
        padding: 16px;
      }
      input,
      select,
      button {
        width: 100%;
        margin-bottom: 12px;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #e5e5e5;
      }
      button {
        background-color: #18a0fb;
        color: white;
        border: none;
        cursor: pointer;
        padding: 10px;
      }
      button:disabled {
        background-color: #cccccc;
      }
      .output {
        margin-top: 16px;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
        padding: 12px;
        max-height: 200px;
        overflow-y: auto;
      }
      .error {
        color: #d93025;
      }
      .success {
        color: #137333;
      }
      .info {
        color: #1a73e8;
      }
    </style>
  </head>
  <body>
    <h2>SVG 아이콘 자동화</h2>

    <div>
      <label for="githubToken">GitHub Personal Access Token:</label>
      <input id="githubToken" type="password" placeholder="ghp_..." />
    </div>

    <button id="exportButton" disabled>아이콘 내보내기 및 PR 생성</button>

    <div class="output" id="output">로그 메시지가 여기에 표시됩니다.</div>

    <script>
      let svgExports = [];
      const output = document.getElementById('output');
      const exportButton = document.getElementById('exportButton');
      const githubTokenInput = document.getElementById('githubToken');

      // GitHub 토큰 입력 감지
      githubTokenInput.addEventListener('input', () => {
        const token = githubTokenInput.value.trim();
        exportButton.disabled = !token;
      });

      // 피그마로부터 메시지 수신
      window.onmessage = async (event) => {
        const msg = event.data.pluginMessage;

        if (msg.type === 'svg-exports') {
          svgExports = msg.data;
          log(`${svgExports.length}개의 아이콘이 내보내졌습니다.`, 'success');
          
          // 아이콘 내보내기가 완료되면 GitHub에 푸시
          await pushToGitHub();
        } else if (msg.type === 'error') {
          log(msg.message, 'error');
        }
      };

      // 로그 메시지 표시
      function log(message, type = '') {
        const p = document.createElement('p');
        p.textContent = message;
        p.className = type;
        output.appendChild(p);
        output.scrollTop = output.scrollHeight;
      }

      // 아이콘 내보내기 버튼 클릭
      exportButton.onclick = async () => {
        try {
          const token = githubTokenInput.value.trim();
          
          if (!token) {
            log('GitHub 토큰을 입력해주세요.', 'error');
            return;
          }

          output.innerHTML = '';
          log('브랜치 생성 시작...');
          await createBranch(token);
          log('브랜치 생성 완료', 'success');
          
          log('아이콘 내보내기 시작...');
          parent.postMessage({ 
            pluginMessage: { 
              type: 'export-svg',
              data: {
                path: 'packages/shopl-assets/src/icons/assets'
              }
            } 
          }, '*');
        } catch (error) {
          log(`오류: ${error.message}`, 'error');
        }
      };

      // GitHub에 푸시
      async function pushToGitHub() {
        try {
          const token = githubTokenInput.value.trim();
          
          log('GitHub에 파일 업로드 중...');
          for (const item of svgExports) {
            await uploadFile(token, item);
          }
          log('GitHub 파일 업로드 완료', 'success');
          log('GitHub Actions가 자동으로 실행됩니다...', 'info');
        } catch (error) {
          log(`GitHub 업로드 오류: ${error.message}`, 'error');
        }
      }

      // 파일 업로드
      async function uploadFile(token, item) {
        const fileName = item.name.split('/').pop(); // 폴더 경로 제거
        const path = `packages/shopl-assets/src/icons/assets/${fileName}.svg`;
        const content = btoa(unescape(encodeURIComponent(item.data)));

        const response = await fetch(
          `https://api.github.com/repos/shopl/shoplflow/contents/${path}`,
          {
            method: 'PUT',
            headers: {
              Authorization: `token ${token}`,
              'Content-Type': 'application/json',
              Accept: 'application/vnd.github.v3+json',
            },
            body: JSON.stringify({
              message: 'icon 추가',
              content: content,
              branch: 'update/icon',
            }),
          }
        );

        if (!response.ok) {
          const error = await response.json();
          throw new Error(`파일 업로드 실패: ${error.message}`);
        }
      }

      // 브랜치 생성
      async function createBranch(token) {
        try {
          // 1. main 브랜치의 최신 커밋 SHA 가져오기
          log('main 브랜치 정보 가져오는 중...');
          const mainRefResponse = await fetch(
            'https://api.github.com/repos/shopl/shoplflow/git/refs/heads/main',
            {
              headers: {
                Authorization: `token ${token}`,
                'Content-Type': 'application/json',
                Accept: 'application/vnd.github.v3+json',
              },
            }
          );

          if (!mainRefResponse.ok) {
            const error = await mainRefResponse.json();
            log(`main 브랜치 정보 가져오기 실패: ${JSON.stringify(error)}`, 'error');
            throw new Error(`main 브랜치 정보 가져오기 실패: ${mainRefResponse.statusText}`);
          }

          const mainRef = await mainRefResponse.json();
          const mainSha = mainRef.object.sha;
          log(`main 브랜치 SHA: ${mainSha}`, 'success');

          // 2. 새 브랜치 생성
          log('새 브랜치 생성 중...');
          const response = await fetch(
            'https://api.github.com/repos/shopl/shoplflow/git/refs',
            {
              method: 'POST',
              headers: {
                Authorization: `token ${token}`,
                'Content-Type': 'application/json',
                Accept: 'application/vnd.github.v3+json',
              },
              body: JSON.stringify({
                ref: 'refs/heads/update/icon',
                sha: mainSha,
              }),
            }
          );

          if (!response.ok) {
            const error = await response.json();
            log(`브랜치 생성 응답: ${JSON.stringify(error)}`, 'error');
            
            if (error.message && error.message.includes('Reference already exists')) {
              log('브랜치가 이미 존재합니다. 해당 브랜치를 사용합니다.', 'success');
              return true;
            }
            throw new Error(`브랜치 생성 실패: ${response.statusText}`);
          }

          const result = await response.json();
          log(`브랜치 생성 성공: ${JSON.stringify(result)}`, 'success');
          return true;
        } catch (error) {
          log(`브랜치 생성 상세 오류: ${error.message}`, 'error');
          throw new Error(`브랜치 생성 오류: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
